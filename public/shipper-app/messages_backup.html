<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <link rel="stylesheet" href="../shared/css/tailwind.min.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ - FastShip Global</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/custom.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../config/supabase.js"></script>
    <script src="assets/js/session-manager.js"></script>
    <script src="../shared/js/organized-messaging.js"></script>
    <script src="../shared/js/enhanced-notifications-v2.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .tab-button {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .tab-button.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-color: rgba(255, 255, 255, 0.4);
        }
        .tab-button:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }
        .new-message-flash {
            animation: messageFlash 3s ease-in-out;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4) !important;
            transform: scale(1.02);
        }
        @keyframes messageFlash {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto p-6">
        <!-- Header -->
        <div class="glass-card p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-white mb-2">
                        <i class="fas fa-comments mr-2"></i>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„ØªÙˆØ§ØµÙ„
                        <span class="text-sm bg-green-500 text-white px-2 py-1 rounded-full ml-2">
                            <i class="fas fa-circle text-green-300 mr-1"></i>Ù…Ø¨Ø§Ø´Ø±
                        </span>
                    </h1>
                    <p class="text-gray-200">ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø´Ø§Ø­Ù†ÙŠÙ† ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Ø¡ - Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªØ¸Ù‡Ø± ÙÙˆØ±Ø§Ù‹</p>
                </div>
                <button onclick="newMessage()" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold">
                    <i class="fas fa-plus ml-2"></i>Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
                </button>
            </div>
        </div>

        <!-- ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
        <script>
        let currentTab = 'inbox';
        let allMessages = [];
        let currentChatUser = null;

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        function switchTab(tab) {
            currentTab = tab;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');

            // Ø¥Ø¯Ø§Ø±Ø© Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
            const chatInterface = document.getElementById('chatInterface');
            const messagesContainer = document.getElementById('messagesContainer');
            const chatConversationsList = document.getElementById('chatConversationsList');

            if (tab === 'chat') {
                if (chatInterface) chatInterface.classList.add('hidden');
                if (messagesContainer) messagesContainer.classList.add('hidden');
                if (chatConversationsList) chatConversationsList.classList.remove('hidden');

                // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
                displayChatConversations();
            } else {
                if (chatInterface) chatInterface.classList.add('hidden');
                if (messagesContainer) messagesContainer.classList.remove('hidden');
                if (chatConversationsList) chatConversationsList.classList.add('hidden');
                // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
                displayMessages();
            }
        }
        </script>

        <!-- Message Tabs -->
        <div class="glass-card p-4 mb-6">
            <div class="flex justify-between items-center mb-4">
                <div class="flex space-x-1 space-x-reverse">
                    <button onclick="switchTab('inbox')" id="inboxTab" class="tab-button active flex-1 py-3 px-4 rounded-lg text-center font-medium transition-all">
                        <i class="fas fa-inbox ml-2"></i>Ø§Ù„ÙˆØ§Ø±Ø¯ (<span id="inboxCount">0</span>)
                    </button>
                    <button onclick="switchTab('sent')" id="sentTab" class="tab-button flex-1 py-3 px-4 rounded-lg text-center font-medium transition-all">
                        <i class="fas fa-paper-plane ml-2"></i>Ø§Ù„Ù…Ø±Ø³Ù„
                    </button>
                    <button onclick="switchTab('chat')" id="chatTab" class="tab-button flex-1 py-3 px-4 rounded-lg text-center font-medium transition-all">
                        <i class="fas fa-comments ml-2"></i>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
                    </button>
                </div>
                <div class="flex items-center text-sm text-gray-300">
                    <i class="fas fa-wifi text-green-400 ml-2" id="connectionStatus"></i>
                    <span id="connectionText">Ù…ØªØµÙ„</span>
                </div>
            </div>
        </div>

        <!-- Chat Interface -->
        <div id="chatInterface" class="glass-card p-0 mb-6 hidden">
            <div class="flex justify-between items-center px-4 py-3 border-b border-gray-200">
                <div class="flex items-center gap-2">
                    <i class="fas fa-user-circle text-2xl text-green-600"></i>
                    <div>
                        <span id="chatUserName" class="font-bold text-lg text-white">Ø§Ù„Ø´Ø§Ø­Ù†</span>
                        <p id="chatUserStatus" class="text-xs text-gray-300">Ù…ØªØµÙ„</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="switchTab('chat')" class="text-gray-300 hover:text-blue-400 transition-colors">
                        <i class="fas fa-plus text-lg"></i>
                    </button>
                    <button onclick="startVoiceCall()" class="text-gray-300 hover:text-green-400 transition-colors">
                        <i class="fas fa-phone text-lg"></i>
                    </button>
                    <button onclick="startVideoCall()" class="text-gray-300 hover:text-green-400 transition-colors">
                        <i class="fas fa-video text-lg"></i>
                    </button>
                    <button onclick="closeChatInterface()" class="text-gray-300 hover:text-red-400 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div id="chatMessages" class="p-4 h-96 overflow-y-auto bg-white/10">
                <!-- Messages will be loaded here -->
            </div>

            <div class="px-4 py-3 border-t border-gray-200 bg-white/10">
                <form id="chatForm" class="flex items-center gap-2">
                    <button type="button" onclick="attachFile()" class="text-gray-300 hover:text-green-400 transition-colors">
                        <i class="fas fa-paperclip text-lg"></i>
                    </button>
                    <button type="button" onclick="insertEmoji()" class="text-gray-300 hover:text-green-400 transition-colors">
                        <i class="fas fa-smile text-lg"></i>
                    </button>
                    <input id="chatInput" type="text" class="flex-1 rounded-lg border border-gray-300 px-3 py-2 bg-white/20 text-white placeholder-gray-300 focus:outline-none focus:ring-2 focus:ring-green-400" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." autocomplete="off" required />
                    <button type="submit" class="btn-primary px-4 py-2 rounded-lg text-white font-semibold">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- Messages List -->
        <div class="glass-card p-6">
            <div id="messagesContainer">
                <!-- Messages will be loaded here -->
                <div class="text-center py-12">
                    <i class="fas fa-envelope-open text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-300 text-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                    <p class="text-gray-400 text-sm">Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ø´Ø§Ø­Ù†ÙŠÙ† ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Ø¡</p>
                    <button onclick="newMessage()" class="mt-4 btn-primary text-white px-6 py-3 rounded-lg font-semibold">
                        Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    </button>
                </div>
            </div>
            <!-- Chat Conversations List (Hidden by default) -->
            <div id="chatConversationsList" class="hidden p-4 space-y-3 bg-white/10 rounded-lg">
                <!-- Chat conversations will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©: ÙÙ‚Ø· Ø§Ù„Ø´Ø§Ø­Ù† ÙŠØ¯Ø®Ù„
        document.addEventListener('DOMContentLoaded', async function() {
            await window.sessionManager.init();
            const user = window.sessionManager.getCurrentUser();
            if (!user || (user.profile?.user_type !== 'shipper')) {
                alert('Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ø£ØµØ­Ø§Ø¨ Ø§Ù„Ø´Ø­Ù†Ø§Øª ÙÙ‚Ø·');
                window.sessionManager.goToDashboard();
                return;
            }
            console.log('âœ… User authenticated as shipper:', user.email);
            
            // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            requestNotificationPermission();
            
            loadMessages();
            openNewChatFromSearch();
        });

        // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        function displayChatConversations() {
            const user = window.sessionManager.getCurrentUser();
            if (!user?.profile?.id) {
                console.log('âš ï¸ Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ displayChatConversations');
                return;
            }

            const userId = user.profile.id;
            console.log('ğŸ’¬ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:', userId);

            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©
            const conversations = new Map();

            allMessages.forEach(message => {
                const otherUserId = message.sender_id === userId ? message.receiver_id : message.sender_id;
                const otherUser = message.sender_id === userId ? message.receiver : message.sender;

                if (!conversations.has(otherUserId)) {
                    conversations.set(otherUserId, {
                        userId: otherUserId,
                        user: otherUser,
                        lastMessage: message,
                        unreadCount: 0
                    });
                }

                // Ø¹Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
                if (message.receiver_id === userId && !message.is_read) {
                    conversations.get(otherUserId).unreadCount++;
                }

                // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
                if (new Date(message.created_at) > new Date(conversations.get(otherUserId).lastMessage.created_at)) {
                    conversations.get(otherUserId).lastMessage = message;
                }
            });

            const chatList = document.getElementById('chatConversationsList');
            if (!chatList) return;

            if (conversations.size === 0) {
                chatList.innerHTML = '<div class="text-center py-8 text-gray-500">' +
                    '<i class="fas fa-comments text-4xl mb-4"></i>' +
                    '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù…ØªØ§Ø­Ø©</p>' +
                    '<p class="text-sm">Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª</p>' +
                    '</div>';
                return;
            }

            chatList.innerHTML = Array.from(conversations.values())
                .sort((a, b) => new Date(b.lastMessage.created_at) - new Date(a.lastMessage.created_at))
                .map(conv => '<div class="border-b border-gray-200 pb-3 mb-3 last:border-0 last:pb-0 last:mb-0 cursor-pointer hover:bg-gray-50 transition-colors" onclick="openChatInterface(\'' + (conv.user?.full_name || 'Ù…Ø³ØªØ®Ø¯Ù…') + '\', \'' + conv.userId + '\', \'' + (conv.lastMessage?.shipment_id || '') + '\')">' +
                        '<div class="flex items-center justify-between">' +
                            '<div class="flex items-center">' +
                                '<div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center ml-3">' +
                                    '<i class="fas fa-user text-white"></i>' +
                                '</div>' +
                                '<div class="flex-1">' +
                                    '<h4 class="font-semibold text-gray-800">' + (conv.user?.full_name || 'Ù…Ø³ØªØ®Ø¯Ù…') + '</h4>' +
                                    '<p class="text-sm text-gray-600 truncate">' + (conv.lastMessage?.content || '') + '</p>' +
                                '</div>' +
                            '</div>' +
                            '<div class="text-left">' +
                                '<p class="text-xs text-gray-500">' + new Date(conv.lastMessage?.created_at).toLocaleDateString('ar-SA') + '</p>' +
                                (conv.unreadCount > 0 ? '<span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full">' + conv.unreadCount + '</span>' : '') +
                            '</div>' +
                        '</div>' +
                    '</div>'
                ).join('');
        }

        // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                console.log('Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª:', permission);
                
                if (permission === 'granted') {
                    console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØµÙØ­');
                } else {
                    console.log('âŒ ØªÙ… Ø±ÙØ¶ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØµÙØ­');
                }
            }
        }

        // ÙØªØ­ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª
        function openNewChatFromSearch() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    const urlParams = new URLSearchParams(window.location.search);
                    const newChat = urlParams.get('newChat');
                    
                    if (newChat === 'true') {
                        const shipmentId = urlParams.get('shipmentId');
                        const carrierName = urlParams.get('carrierName');
                        const carrierUserId = urlParams.get('carrierUserId');
                        
                        if (shipmentId && carrierName && carrierUserId) {
                            openChatInterface(carrierName, carrierUserId, shipmentId);
                        }
                    }
                });
            } else {
                const urlParams = new URLSearchParams(window.location.search);
                const newChat = urlParams.get('newChat');
                
                if (newChat === 'true') {
                    const shipmentId = urlParams.get('shipmentId');
                    const carrierName = urlParams.get('carrierName');
                    const carrierUserId = urlParams.get('carrierUserId');
                    
                    if (shipmentId && carrierName && carrierUserId) {
                        openChatInterface(carrierName, carrierUserId, shipmentId);
                    }
                }
            }
        }

        // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        openNewChatFromSearch();

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¹Ù†Ø¯ Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('beforeunload', function() {
            if (window.messagesSubscription) {
                window.messagesSubscription.unsubscribe();
                console.log('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„');
            }
        });

        async function loadMessages() {
            try {
                const user = window.sessionManager.getCurrentUser();
                if (!user) return;

                console.log('ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:', user.profile?.id || user.id);

                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµØ­ÙŠØ­
                const userId = user.profile?.id;
                if (!userId) {
                    console.error('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…');
                    return;
                }

                // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const { data, error } = await window.supabaseClient
                    .from('messages')
                    .select(`
                        *,
                        sender:users!sender_id(id, full_name, email, user_type),
                        receiver:users!receiver_id(id, full_name, email, user_type)
                    `)
                    .or('sender_id.eq.' + userId + ',receiver_id.eq.' + userId)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:', error);
                    throw error;
                }

                console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„', data?.length || 0, 'Ø±Ø³Ø§Ù„Ø©');
                allMessages = data || [];
                
                displayMessages();
                displayChatConversations();
                updateCounts();

                // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø±Ø³Ø§Ø¦Ù„
                subscribeToRealTimeMessages();

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: ' + error.message);
            }
        }

        // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        function subscribeToRealTimeMessages() {
            const user = window.sessionManager.getCurrentUser();
            if (!user?.profile?.id) return;

            const userId = user.profile.id;

            // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if (window.messagesSubscription) {
                window.messagesSubscription.unsubscribe();
            }

            // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            window.messagesSubscription = window.supabaseClient
                .channel('messages_realtime')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages',
                    filter: 'receiver_id=eq.' + userId
                }, (payload) => {
                    console.log('Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØµÙ„Øª:', payload.new);
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                    allMessages.unshift(payload.new);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                    displayMessages();
                    updateCounts();
                    
                    // Ø¥Ø´Ø¹Ø§Ø± ØµÙˆØªÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ FastShip', {
                            body: 'Ù…Ù†: ' + (payload.new.sender?.full_name || 'Ù…Ø±Ø³Ù„ Ø¬Ø¯ÙŠØ¯'),
                            icon: '/favicon.ico',
                            tag: 'fastship-message'
                        });
                    }
                    
                    // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø¥Ø´Ø¹Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
                    playNotificationSound();
                    
                    // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    highlightNewMessage(payload.new.id);
                })
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'messages',
                    filter: 'sender_id=eq.' + userId + ',receiver_id=eq.' + userId
                }, (payload) => {
                    console.log('Ø±Ø³Ø§Ù„Ø© ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§:', payload.new);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                    const index = allMessages.findIndex(msg => msg.id === payload.new.id);
                    if (index !== -1) {
                        allMessages[index] = payload.new;
                        displayMessages();
                        updateCounts();
                    }
                })
                .subscribe((status) => {
                    console.log('Ø­Ø§Ù„Ø© Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:', status);
                    updateConnectionStatus(status);
                });
        }

        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø¥Ø´Ø¹Ø§Ø±
        function playNotificationSound() {
            try {
                // Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØª Ø¨Ø³ÙŠØ· Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', error);
            }
        }

        // Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¨ØµØ±ÙŠØ§Ù‹
        function highlightNewMessage(messageId) {
            setTimeout(() => {
                const messageElement = document.querySelector('[data-message-id="' + messageId + '"]');
                if (messageElement) {
                    messageElement.classList.add('new-message-flash');
                    setTimeout(() => {
                        messageElement.classList.remove('new-message-flash');
                    }, 3000);
                }
            }, 100);
        }

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        function updateConnectionStatus(status) {
            const statusIcon = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            
            switch (status) {
                case 'SUBSCRIBED':
                    statusIcon.className = 'fas fa-wifi text-green-400 ml-2';
                    statusText.textContent = 'Ù…ØªØµÙ„';
                    statusText.className = 'text-green-400';
                    break;
                case 'CHANNEL_ERROR':
                    statusIcon.className = 'fas fa-exclamation-triangle text-red-400 ml-2';
                    statusText.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
                    statusText.className = 'text-red-400';
                    break;
                case 'TIMED_OUT':
                    statusIcon.className = 'fas fa-clock text-yellow-400 ml-2';
                    statusText.textContent = 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ù‡Ù„Ø©';
                    statusText.className = 'text-yellow-400';
                    break;
                case 'CLOSED':
                    statusIcon.className = 'fas fa-times text-gray-400 ml-2';
                    statusText.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
                    statusText.className = 'text-gray-400';
                    break;
                default:
                    statusIcon.className = 'fas fa-spinner fa-spin text-blue-400 ml-2';
                    statusText.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
                    statusText.className = 'text-blue-400';
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
        function displayMessages() {
            const user = window.sessionManager.getCurrentUser();
            if (!user) return;

            const userId = user.profile?.id || user.id;
            let filteredMessages = [];

            switch (currentTab) {
                case 'inbox':
                    // Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø© (Ø§Ù„ØªÙŠ Ø£Ù†Ø§ Ø§Ù„Ù…Ø³ØªÙ„Ù…)
                    filteredMessages = allMessages.filter(msg => msg.receiver_id === userId);
                    break;
                case 'sent':
                    // Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±Ø³Ù„Ø© (Ø§Ù„ØªÙŠ Ø£Ù†Ø§ Ø§Ù„Ù…Ø±Ø³Ù„)
                    filteredMessages = allMessages.filter(msg => msg.sender_id === userId);
                    break;
                case 'chat':
                    // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©
                    filteredMessages = allMessages;
                    break;
            }

            const container = document.getElementById('messagesContainer');

            if (filteredMessages.length > 0) {
                container.innerHTML = filteredMessages.map(message => {
                    const isIncoming = message.receiver_id === userId;
                    const otherParty = isIncoming ? message.sender : message.receiver;
                    const isUnread = !message.is_read && isIncoming;
                    
                    return '<div class="bg-white/5 rounded-lg p-4 mb-4 border border-white/10 ' + (isUnread ? 'border-l-4 border-l-blue-400 bg-blue-500/10' : '') + '" data-message-id="' + message.id + '">' +
                            '<div class="flex justify-between items-start mb-3">' +
                                '<div class="flex-1">' +
                                    '<div class="flex items-center mb-1">' +
                                        '<h3 class="text-white font-semibold">' +
                                            (isIncoming ? 'Ù…Ù†: ' : 'Ø¥Ù„Ù‰: ') + (otherParty?.full_name || 'Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ') +
                                            (otherParty?.user_type === 'carrier' ? '<span class="text-xs bg-green-500 text-white px-2 py-1 rounded-full mr-2">Ù†Ø§Ù‚Ù„</span>' :
                                              otherParty?.user_type === 'shipper' ? '<span class="text-xs bg-blue-500 text-white px-2 py-1 rounded-full mr-2">Ø´Ø§Ø­Ù†</span>' : '') +
                                        '</h3>' +
                                        (isUnread ? '<span class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full mr-2">Ø¬Ø¯ÙŠØ¯</span>' : '') +
                                    '</div>' +
                                    '<p class="text-gray-300 font-medium text-sm">' + (message.subject || 'Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¶ÙˆØ¹') + '</p>' +
                                    '<p class="text-gray-400 text-sm mt-1">' + ((message.content || '').length > 100 ? (message.content || '').substring(0, 100) + '...' : (message.content || '')) + '</p>' +
                                    (message.message_type ? '<p class="text-xs text-yellow-400 mt-1"><i class="fas fa-tag ml-1"></i>' + (message.message_type === 'match_offer' ? 'Ø¹Ø±Ø¶ Ù†Ù‚Ù„' : message.message_type) + '</p>' : '') +
                                '</div>' +
                                '<span class="text-gray-400 text-xs">' + new Date(message.created_at).toLocaleString('ar-SA') + '</span>' +
                            '</div>' +
                            '<div class="flex gap-2">' +
                                '<button onclick="viewMessage(\'' + message.id + '\')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">' +
                                    '<i class="fas fa-eye ml-1"></i>Ø¹Ø±Ø¶' +
                                '</button>' +
                                '<button onclick="replyMessage(\'' + message.id + '\')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">' +
                                    '<i class="fas fa-reply ml-1"></i>Ø±Ø¯' +
                                '</button>' +
                                (isUnread ? '<button onclick="markAsRead(\'' + message.id + '\')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm">' +
                                    '<i class="fas fa-check ml-1"></i>ØªØ­Ø¯ÙŠØ¯ ÙƒÙ…Ù‚Ø±ÙˆØ¡' +
                                '</button>' : '') +
                            '</div>' +
                        '</div>';
                }).join('');
            } else {
                const emptyMessages = {
                    'inbox': 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ø±Ø¯Ø©',
                    'sent': 'Ù„Ù… ØªØ±Ø³Ù„ Ø£ÙŠ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯',
                    'chat': 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©'
                };
                
                container.innerHTML = '<div class="text-center py-8 text-white/70">' +
                    '<i class="fas fa-envelope-open text-4xl mb-4"></i>' +
                    '<p>' + emptyMessages[currentTab] + '</p>' +
                    (currentTab === 'sent' ? '<button onclick="newMessage()" class="mt-4 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>' : '') +
                '</div>';
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        function updateCounts() {
            const user = window.sessionManager.getCurrentUser();
            if (!user) return;

            const userId = user.profile?.id || user.id;
            
            const inboxCount = allMessages.filter(msg => msg.receiver_id === userId && !msg.is_read).length;
            document.getElementById('inboxCount').textContent = inboxCount;
        }

        function newMessage() {
            // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙ„Ù… ÙˆØ¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
            const recipient = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù… Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„Ø¨Ø­Ø«:');
            if (recipient === null) return;

            const subject = prompt('Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:');
            if (!subject) return;

            const message = prompt('Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:');
            if (!message) return;

            // ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ØŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ ÙˆØ§Ø¬Ù‡Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙ„Ù… Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            alert('Ù…ÙŠØ²Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø³ØªÙƒØªÙ…Ù„ Ù‚Ø±ÙŠØ¨Ø§Ù‹ - ÙŠØªØ·Ù„Ø¨ ÙˆØ§Ø¬Ù‡Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙ„Ù…');
        }

        async function viewMessage(id) {
            try {
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø©
                const { error: updateError } = await supabaseClient
                    .from('messages')
                    .update({ is_read: true })
                    .eq('id', id);

                if (updateError) console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', updateError);

                // Ù‚Ø±Ø§Ø¡Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                const { data, error } = await supabaseClient
                    .from('messages')
                    .select('*, sender:users!sender_id(full_name, email), receiver:users!receiver_id(full_name, email)')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                if (data) {
                    alert('Ù…Ù†: ' + (data.sender?.full_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ') + '\n' +
'Ø¥Ù„Ù‰: ' + (data.receiver?.full_name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ') + '\n' +
'Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹: ' + (data.subject || 'Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¶ÙˆØ¹') + '\n\n' +
(data.content || ''));
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙƒÙ…Ù‚Ø±ÙˆØ¡Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
                    const message = allMessages.find(msg => msg.id === id);
                    if (message) {
                        message.is_read = true;
                    }
                    
                    displayMessages();
                    updateCounts();
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
            }
        }

        async function replyMessage(id) {
            try {
                // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
                const { data, error } = await supabaseClient
                    .from('messages')
                    .select('*, sender:users!sender_id(full_name, email), receiver:users!receiver_id(full_name, email)')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                if (data) {
                    const replySubject = 'Re: ' + (data.subject || 'Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¶ÙˆØ¹');
                    const replyContent = prompt('Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ:', '\n\n--- Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© ---\nÙ…Ù†: ' + (data.sender?.full_name) + '\nØ§Ù„Ù…ÙˆØ¶ÙˆØ¹: ' + (data.subject || 'Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¶ÙˆØ¹') + '\nØ§Ù„ØªØ§Ø±ÙŠØ®: ' + new Date(data.created_at).toLocaleString('ar-SA') + '\n\n' + (data.content || ''));

                    if (replyContent && replyContent.trim()) {
                        const currentUser = window.sessionManager.getCurrentUser();
                        const senderId = currentUser.profile?.id || currentUser.id;
                        const receiverId = data.sender_id === (currentUser.profile?.id || currentUser.id) ? data.receiver_id : data.sender_id;

                        const { error: insertError } = await supabaseClient
                            .from('messages')
                            .insert({
                                sender_id: senderId,
                                receiver_id: receiverId,
                                subject: replySubject,
                                content: replyContent.trim(),
                                shipment_id: data.shipment_id
                            });

                        if (insertError) throw insertError;

                        alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
                        loadMessages(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                    }
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯');
            }
        }

        async function markAsRead(id) {
            try {
                const { error } = await supabaseClient
                    .from('messages')
                    .update({ is_read: true })
                    .eq('id', id);

                if (error) throw error;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
                const message = allMessages.find(msg => msg.id === id);
                if (message) {
                    message.is_read = true;
                }
                
                displayMessages();
                updateCounts();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
            }
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
        let currentChatShipmentId = null;

        // ÙØªØ­ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        function openChatInterface(userName, userId, shipmentId = null) {
            currentChatUser = { name: userName, userId: userId };
            currentChatShipmentId = shipmentId;

            const chatInterface = document.getElementById('chatInterface');
            const messagesContainer = document.getElementById('messagesContainer');
            const chatUserName = document.getElementById('chatUserName');

            if (chatUserName) chatUserName.textContent = userName;
            if (chatInterface) chatInterface.classList.remove('hidden');
            if (messagesContainer) messagesContainer.classList.add('hidden');

            // ØªØ­Ù…ÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            loadChatHistory(userName, shipmentId);

            // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            subscribeToChatMessages(userId, shipmentId);

            // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            setTimeout(() => {
                const chatInput = document.getElementById('chatInput');
                if (chatInput) chatInput.focus();
            }, 300);
        }

        // Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        function showChatSelectionInterface() {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
            const chatForm = document.getElementById('chatForm');
            if (chatForm) chatForm.style.display = 'none';

            // Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            chatMessages.innerHTML = '<div class="text-center py-12">' +
                    '<i class="fas fa-comments text-6xl text-gray-300 mb-6"></i>' +
                    '<h3 class="text-xl font-bold text-white mb-4">Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>' +
                    '<p class="text-gray-300 mb-8">Ø§Ø®ØªØ± Ù†Ø§Ù‚Ù„ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø£Ùˆ Ø§Ø¨Ø­Ø« Ø¹Ù† Ù†Ø§Ù‚Ù„ Ø¬Ø¯ÙŠØ¯</p>' +
                    '<div class="max-w-md mx-auto">' +
                        '<button onclick="showRecentConversations()" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg mb-4 transition">' +
                            '<i class="fas fa-history ml-2"></i>' +
                            'Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©' +
                        '</button>' +
                        '<button onclick="showCarrierSearch()" class="w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition">' +
                            '<i class="fas fa-search ml-2"></i>' +
                            'Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†Ø§Ù‚Ù„ Ø¬Ø¯ÙŠØ¯' +
                        '</button>' +
                    '</div>' +
                '</div>';

            // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
            const chatUserName = document.getElementById('chatUserName');
            if (chatUserName) chatUserName.textContent = 'Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø©';

            const chatUserStatus = document.getElementById('chatUserStatus');
            if (chatUserStatus) chatUserStatus.textContent = '';
        }

        function displayChatConversations() {
            const user = window.sessionManager.getCurrentUser();
            if (!user?.profile?.id) {
                console.log('âš ï¸ Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ displayChatConversations');
                return;
            }

            const userId = user.profile.id;
            console.log('ğŸ’¬ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:', userId);

            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©
            const conversations = new Map();

            allMessages.forEach(message => {
                const otherUserId = message.sender_id === userId ? message.receiver_id : message.sender_id;
                const otherUser = message.sender_id === userId ? message.receiver : message.sender;

                if (!conversations.has(otherUserId)) {
                    conversations.set(otherUserId, {
                        userId: otherUserId,
                        user: otherUser,
                        lastMessage: message,
                        unreadCount: 0
                    });
                }

                // Ø¹Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
                if (message.receiver_id === userId && !message.is_read) {
                    conversations.get(otherUserId).unreadCount++;
                }

                // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
                if (new Date(message.created_at) > new Date(conversations.get(otherUserId).lastMessage.created_at)) {
                    conversations.get(otherUserId).lastMessage = message;
                }
            });

            const chatList = document.getElementById('chatConversationsList');
            if (!chatList) return;

            if (conversations.size === 0) {
                chatList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-comments text-4xl mb-4"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù…ØªØ§Ø­Ø©</p>
                        <p class="text-sm">Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø§Øª</p>
                    </div>
                `;
                return;
            }

            chatList.innerHTML = Array.from(conversations.values())
                .sort((a, b) => new Date(b.lastMessage.created_at) - new Date(a.lastMessage.created_at))
                .map(conv => `
                    <div class="border-b border-gray-200 pb-3 mb-3 last:border-0 last:pb-0 last:mb-0 cursor-pointer hover:bg-gray-50 transition-colors" onclick="openChatInterface('${conv.user?.full_name || 'Ù…Ø³ØªØ®Ø¯Ù…'}', '${conv.userId}', '${conv.lastMessage?.shipment_id || ''}')">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center ml-3">
                                    <i class="fas fa-user text-white"></i>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800">${conv.user?.full_name || 'Ù…Ø³ØªØ®Ø¯Ù…'}</h4>
                                    <p class="text-sm text-gray-600 truncate">${conv.lastMessage?.content || ''}</p>
                                </div>
                            </div>
                            <div class="text-left">
                                <p class="text-xs text-gray-500">${new Date(conv.lastMessage?.created_at).toLocaleDateString('ar-SA')}</p>
                                ${conv.unreadCount > 0 ? `<span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full">${conv.unreadCount}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        function showRecentConversations() {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            const user = window.sessionManager.getCurrentUser();
            if (!user?.profile?.id) return;

            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            const conversations = new Map();

            allMessages.forEach(message => {
                const otherUser = message.sender_id === user.profile.id ? message.receiver : message.sender;
                if (otherUser && !conversations.has(otherUser.id)) {
                    conversations.set(otherUser.id, {
                        user: otherUser,
                        lastMessage: message,
                        shipmentId: message.trip_id
                    });
                }
            });

            if (conversations.size === 0) {
                chatMessages.innerHTML = '<div class="text-center py-12">' +
                        '<i class="fas fa-inbox text-4xl text-gray-400 mb-4"></i>' +
                        '<p class="text-gray-300 mb-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</p>' +
                        '<button onclick="showChatSelectionInterface()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">' +
                            '<i class="fas fa-arrow-left ml-2"></i>' +
                            'Ø§Ù„Ø¹ÙˆØ¯Ø©' +
                        '</button>' +
                    '</div>';
                return;
            }

            let conversationsHtml = '<div class="mb-4">' +
                    '<button onclick="showChatSelectionInterface()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg mb-4">' +
                        '<i class="fas fa-arrow-left ml-2"></i>' +
                        'Ø§Ù„Ø¹ÙˆØ¯Ø©' +
                    '</button>' +
                    '<h4 class="text-white font-bold mb-4">Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø©:</h4>' +
                '</div>' +
                '<div class="space-y-3">';

            conversations.forEach((conv, userId) => {
                conversationsHtml += '<div onclick="startChatWithUser(\'' + conv.user.full_name + '\', \'' + userId + '\', \'' + conv.shipmentId + '\')"' +
                         'class="bg-white/10 hover:bg-white/20 p-4 rounded-lg cursor-pointer transition border border-white/20">' +
                        '<div class="flex items-center justify-between">' +
                            '<div class="flex items-center">' +
                                '<i class="fas fa-user-circle text-2xl text-green-400 ml-3"></i>' +
                                '<div>' +
                                    '<h5 class="text-white font-semibold">' + conv.user.full_name + '</h5>' +
                                    '<p class="text-gray-300 text-sm">' + (conv.user.user_type === 'carrier' ? 'Ù†Ø§Ù‚Ù„' : 'Ø´Ø§Ø­Ù†') + '</p>' +
                                '</div>' +
                            '</div>' +
                            '<div class="text-left">' +
                                '<p class="text-gray-400 text-xs">' + new Date(conv.lastMessage.created_at).toLocaleDateString('ar-SA') + '</p>' +
                                '<p class="text-gray-300 text-sm truncate max-w-xs">' + (conv.lastMessage.content?.substring(0, 30) || 'Ø±Ø³Ø§Ù„Ø©') + '...</p>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
            });

            conversationsHtml += '</div>';
            chatMessages.innerHTML = conversationsHtml;
        }

        // Ø¨Ø¯Ø¡ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯Ø¯
        function startChatWithUser(userName, userId, shipmentId) {
            openChatInterface(userName, userId, shipmentId);
        }

        // Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†Ø§Ù‚Ù„ Ø¬Ø¯ÙŠØ¯
        function showCarrierSearch() {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            chatMessages.innerHTML = '<div class="mb-4">' +
                    '<button onclick="showChatSelectionInterface()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg mb-4">' +
                        '<i class="fas fa-arrow-left ml-2"></i>' +
                        'Ø§Ù„Ø¹ÙˆØ¯Ø©' +
                    '</button>' +
                    '<h4 class="text-white font-bold mb-4">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†Ø§Ù‚Ù„:</h4>' +
                '</div>' +
                '<div class="bg-white/10 p-6 rounded-lg">' +
                    '<div class="mb-4">' +
                        '<input type="text" id="carrierSearchInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù†Ø§Ù‚Ù„ Ø£Ùˆ Ø±Ù‚Ù…Ù‡..."' +
                               'class="w-full px-4 py-3 bg-white/20 text-white placeholder-gray-300 rounded-lg border border-white/30 focus:outline-none focus:ring-2 focus:ring-green-400">' +
                    '</div>' +
                    '<div id="carrierSearchResults" class="space-y-2 max-h-64 overflow-y-auto">' +
                        '<!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->' +
                    '</div>' +
                    '<button onclick="searchCarriers()" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg mt-4 transition">' +
                        '<i class="fas fa-search ml-2"></i>' +
                        'Ø¨Ø­Ø«' +
                    '</button>' +
                '</div>';

            // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø«
            setTimeout(() => {
                const searchInput = document.getElementById('carrierSearchInput');
                if (searchInput) {
                    searchInput.focus();
                    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
                    searchInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            searchCarriers();
                        }
                    });
                }
            }, 100);
        }

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†Ø§Ù‚Ù„ÙŠÙ†
        async function searchCarriers() {
            const searchInput = document.getElementById('carrierSearchInput');
            const searchTerm = searchInput.value.trim();

            if (!searchTerm) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ù„Ù„Ø¨Ø­Ø«');
                return;
            }

            const resultsContainer = document.getElementById('carrierSearchResults');
            resultsContainer.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin text-white"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</div>';

            try {
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†Ø§Ù‚Ù„ÙŠÙ†
                const { data: carriers, error } = await supabaseClient
                    .from('users')
                    .select('id, full_name, email, phone, user_type')
                    .eq('user_type', 'carrier')
                    .or('full_name.ilike.%' + searchTerm + '%,phone.ilike.%' + searchTerm + '%,email.ilike.%' + searchTerm + '%')
                    .limit(10);

                if (error) throw error;

                if (!carriers || carriers.length === 0) {
                    resultsContainer.innerHTML = '<div class="text-center py-4 text-gray-300">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø§Ù‚Ù„ÙŠÙ† Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ†</div>';
                    return;
                }

                let resultsHtml = '';
                carriers.forEach(carrier => {
                    resultsHtml += '<div onclick="startChatWithUser(\'' + carrier.full_name + '\', \'' + carrier.id + '\', null)"' +
                             'class="bg-white/5 hover:bg-white/10 p-3 rounded-lg cursor-pointer transition border border-white/10">' +
                            '<div class="flex items-center">' +
                                '<i class="fas fa-user-circle text-xl text-blue-400 ml-3"></i>' +
                                '<div>' +
                                    '<h6 class="text-white font-medium">' + carrier.full_name + '</h6>' +
                                    '<p class="text-gray-400 text-sm">' + carrier.email + '</p>' +
                                '</div>' +
                            '</div>' +
                        '</div>';
                });

                resultsContainer.innerHTML = resultsHtml;

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†Ø§Ù‚Ù„ÙŠÙ†:', error);
                resultsContainer.innerHTML = '<div class="text-center py-4 text-red-300">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«</div>';
            }
        }

        // ÙØªØ­ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ
        function openNewChatFromSearch() {
            console.log('ğŸ” ÙØ­Øµ URL Ù„ÙØªØ­ Ø¯Ø±Ø¯Ø´Ø© Ø¬Ø¯ÙŠØ¯Ø©...');
            const urlParams = new URLSearchParams(window.location.search);
            const newChat = urlParams.get('newChat');
            const shipmentId = urlParams.get('shipmentId');
            const carrierName = urlParams.get('carrierName');
            const carrierUserId = urlParams.get('carrierUserId');

            console.log('ğŸ“‹ Ù…Ø¹Ø§Ù…Ù„Ø§Øª URL:', { newChat, shipmentId, carrierName, carrierUserId });

            if (newChat === 'true' && carrierName && carrierUserId) {
                console.log('ğŸ’¬ ÙØªØ­ Ø¯Ø±Ø¯Ø´Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹:', carrierName, carrierUserId);
                switchTab('chat');
                openChatInterface(carrierName, carrierUserId, null);
            } else {
                console.log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±Ø¯Ø´Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„ÙØªØ­Ù‡Ø§');
            }
        }

        // Ø¥ØºÙ„Ø§Ù‚ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function closeChatInterface() {
            // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©
            if (window.chatSubscription) {
                window.chatSubscription.unsubscribe();
                window.chatSubscription = null;
            }

            document.getElementById('chatInterface').classList.add('hidden');
            document.getElementById('messagesContainer').classList.remove('hidden');
            currentChatUser = null;
            currentChatShipmentId = null;

            // Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            document.getElementById('chatMessages').innerHTML = '';
        }

        // ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        async function loadChatHistory(userName, shipmentId) {
            try {
                const user = window.sessionManager.getCurrentUser();
                if (!user?.profile?.id) return;

                console.log('ğŸ” ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹:', currentChatUser, 'Ù„Ù„Ø´Ø­Ù†Ø©:', shipmentId);

                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø¨Ø¯ÙˆÙ† Ø´Ø±Ø· shipment_id)
                const { data: messages, error } = await supabaseClient
                    .from('messages')
                    .select(`
                        *,
                        sender:users!sender_id(full_name, email, user_type),
                        receiver:users!receiver_id(full_name, email, user_type)
                    `)
                    .or(`sender_id.eq.${user.profile.id},receiver_id.eq.${user.profile.id}`)
                    .or(`sender_id.eq.${currentChatUser.userId},receiver_id.eq.${currentChatUser.userId}`)
                    .order('created_at', { ascending: true });

                if (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:', error);
                    throw error;
                }

                // ØªØµÙÙŠØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„ØªØ´Ù…Ù„ ÙÙ‚Ø· Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø­Ø¯Ø¯ÙŠÙ†
                const chatMessages = messages.filter(msg =>
                    (msg.sender_id === user.profile.id && msg.receiver_id === currentChatUser.userId) ||
                    (msg.sender_id === currentChatUser.userId && msg.receiver_id === user.profile.id)
                );

                console.log('ğŸ“š Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…ÙÙ„ØªØ±Ø©:', chatMessages);
                displayChatMessages(chatMessages || []);

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:', error);
            }
        }

        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        function displayChatMessages(messages) {
            const container = document.getElementById('chatMessages');
            if (!container) return;

            container.innerHTML = '';

            const user = window.sessionManager.getCurrentUser();
            const currentUserId = user?.profile?.id;

            messages.forEach(message => {
                const isOwnMessage = message.sender_id === currentUserId;
                const messageElement = document.createElement('div');
                messageElement.className = isOwnMessage ? 'text-right mb-3' : 'text-left mb-3';

                messageElement.innerHTML = '<div class="inline-block max-w-xs lg:max-w-md">' +
                        '<div class="' + (isOwnMessage ? 'bg-green-500 text-white rounded-l-lg rounded-tr-lg' : 'bg-gray-200 text-gray-800 rounded-r-lg rounded-tl-lg') + ' px-4 py-2 shadow">' +
                            '<p class="text-sm">' + message.content + '</p>' +
                        '</div>' +
                        '<p class="text-xs text-gray-400 mt-1">' +
                            new Date(message.created_at).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) +
                        '</p>' +
                    '</div>';

                container.appendChild(messageElement);
            });

            // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
            container.scrollTop = container.scrollHeight;
        }

        // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
        function subscribeToChatMessages(otherUserId, shipmentId) {
            const user = window.sessionManager.getCurrentUser();
            if (!user?.profile?.id) {
                console.log('âš ï¸ Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©');
                return;
            }

            // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if (window.chatSubscription) {
                window.chatSubscription.unsubscribe();
            }

            const currentUserId = user.profile.id;
            console.log('ğŸ’¬ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹:', otherUserId, 'Ù„Ù„Ø´Ø­Ù†Ø©:', shipmentId);

            try {
                // Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
                window.chatSubscription = supabaseClient
                    .channel(`chat_${currentUserId}_${otherUserId}`)
                    .on('postgres_changes', {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'messages',
                        filter: `sender_id=eq.${otherUserId},receiver_id=eq.${currentUserId},message_type=eq.general`
                    }, (payload) => {
                        console.log('Ø±Ø³Ø§Ù„Ø© Ø¯Ø±Ø¯Ø´Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØµÙ„Øª:', payload.new);

                        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©
                        const messageElement = document.createElement('div');
                        messageElement.className = 'text-left mb-3'; // Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø±
                        messageElement.innerHTML = '<div class="inline-block max-w-xs lg:max-w-md">' +
                                '<div class="bg-gray-200 text-gray-800 rounded-r-lg rounded-tl-lg px-4 py-2 shadow">' +
                                    '<p class="text-sm">' + payload.new.content + '</p>' +
                                '</div>' +
                                '<p class="text-xs text-gray-400 mt-1">' +
                                    new Date(payload.new.created_at).toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) +
                                '</p>' +
                            '</div>';

                        document.getElementById('chatMessages').appendChild(messageElement);

                        // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
                        const container = document.getElementById('chatMessages');
                        container.scrollTop = container.scrollHeight;

                        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø¥Ø´Ø¹Ø§Ø±
                        playNotificationSound();

                        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù…ØªØµÙ„
                        updateChatUserStatus('Ù…ØªØµÙ„');
                    })
                    .subscribe((status) => {
                        console.log('Ø­Ø§Ù„Ø© Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©:', status);
                        if (status === 'SUBSCRIBED') {
                            updateChatUserStatus('Ù…ØªØµÙ„');
                        } else if (status === 'CHANNEL_ERROR') {
                            updateChatUserStatus('ØºÙŠØ± Ù…ØªØµÙ„');
                        }
                    });
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©:', error);
                updateChatUserStatus('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        function updateChatUserStatus(status) {
            const statusElement = document.getElementById('chatUserStatus');
            if (statusElement) {
                statusElement.textContent = status;
                statusElement.className = 'text-xs ' + (
                    status === 'Ù…ØªØµÙ„' ? 'text-green-400' :
                    status === 'ØºÙŠØ± Ù…ØªØµÙ„' ? 'text-red-400' : 'text-yellow-400'
                );
            }
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        async function sendChatMessage(message) {
            try {
                const user = window.sessionManager.getCurrentUser();
                if (!user?.profile?.id) {
                    alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                    return { success: false, error: 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹' };
                }

                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…
                if (!currentChatUser.userId) {
                    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±');
                    return { success: false, error: 'Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±' };
                }

                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                const { data: newMessage, error: sendError } = await window.supabaseClient
                    .from('messages')
                    .insert({
                        sender_id: user.profile.id,
                        receiver_id: currentChatUser.userId,
                        subject: 'Ø±Ø³Ø§Ù„Ø© Ø¯Ø±Ø¯Ø´Ø©',
                        content: message,
                        shipment_id: currentChatShipmentId,
                        message_type: 'general'
                    })
                    .select()
                    .single();

                if (sendError) throw sendError;

                // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙˆØ±Ø§Ù‹
                const messageElement = document.createElement('div');
                messageElement.className = 'text-right mb-3';
                messageElement.innerHTML = '<div class="inline-block max-w-xs lg:max-w-md">' +
                        '<div class="bg-green-500 text-white rounded-l-lg rounded-tr-lg px-4 py-2 shadow">' +
                            '<p class="text-sm">' + message + '</p>' +
                        '</div>' +
                        '<p class="text-xs text-gray-400 mt-1">' +
                            new Date().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) +
                        '</p>' +
                    '</div>';

                document.getElementById('chatMessages').appendChild(messageElement);
                document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;

                // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªÙ„Ù…
                await window.sessionManager.createNotification(
                    currentChatUser.userId,
                    'message',
                    'Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø´Ø§Ø­Ù†',
                    message,
                    currentChatShipmentId
                );

                return { success: true };

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
                return { success: false, error: error.message };
            }
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        document.getElementById('chatForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            input.value = '';
            input.disabled = true;

            const result = await sendChatMessage(message);

            if (result.success) {
                // ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­
                console.log('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                alert('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ' + result.error);
            }

            input.disabled = false;
            input.focus();
        });

        // Ø¯ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©
        function startVoiceCall() {
            alert('Ù…ÙŠØ²Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±');
        }

        function startVideoCall() {
            alert('Ù…ÙŠØ²Ø© Ø§Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª Ø§Ù„Ù…Ø±Ø¦ÙŠØ© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±');
        }

        function attachFile() {
            alert('Ù…ÙŠØ²Ø© Ø¥Ø±ÙØ§Ù‚ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±');
        }

        function insertEmoji() {
            alert('Ù…ÙŠØ²Ø© Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ© Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±');
        }
    </script>
</body>
</html>