<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <link rel="stylesheet" href="../shared/css/tailwind.min.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إضافة شحنة جديدة - الشاحن | FastShip</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/custom.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../config/supabase.js"></script>
    <script src="assets/js/session-manager.js"></script>
    <link rel="stylesheet" href="assets/css/main.css">
</head>
<body class="bg-gradient-to-r from-blue-500 to-purple-600 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white/10 backdrop-blur-lg rounded-xl p-8 w-full max-w-2xl shadow-lg">
        <h1 class="text-2xl font-bold text-white mb-6 text-center">
            <i class="fas fa-plus mr-2"></i>إضافة شحنة جديدة
        </h1>
        <form id="addShipmentForm" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-white mb-1">بلد الاستلام</label>
                    <input type="text" id="pickup_country" name="pickup_country" required class="form-input w-full rounded-lg" placeholder="مثال: السعودية">
                </div>
                <div>
                    <label class="block text-white mb-1">مدينة الاستلام</label>
                    <input type="text" id="pickup_city" name="pickup_city" required class="form-input w-full rounded-lg" placeholder="مثال: الرياض">
                </div>
                <div>
                    <label class="block text-white mb-1">بلد التوصيل</label>
                    <input type="text" id="delivery_country" name="delivery_country" required class="form-input w-full rounded-lg" placeholder="مثال: الإمارات">
                </div>
                <div>
                    <label class="block text-white mb-1">مدينة التوصيل</label>
                    <input type="text" id="delivery_city" name="delivery_city" required class="form-input w-full rounded-lg" placeholder="مثال: دبي">
                </div>
            </div>
            <div>
                <label class="block text-white mb-1">عنوان الاستلام</label>
                <textarea id="pickup_address" name="pickup_address" required class="form-input w-full rounded-lg" rows="2" placeholder="مثال: شارع الملك فهد، حي العليا، الرياض"></textarea>
            </div>
            <div>
                <label class="block text-white mb-1">عنوان التوصيل</label>
                <textarea id="delivery_address" name="delivery_address" required class="form-input w-full rounded-lg" rows="2" placeholder="مثال: شارع الشيخ زايد، دبي مارينا، دبي"></textarea>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-white mb-1">تاريخ الاستلام</label>
                    <input type="date" id="pickup_date" name="pickup_date" required class="form-input w-full rounded-lg">
                </div>
                <div>
                    <label class="block text-white mb-1">وزن الشحنة (كجم)</label>
                    <input type="number" id="weight_kg" name="weight_kg" required min="1" class="form-input w-full rounded-lg" placeholder="مثال: 50">
                </div>
            </div>
            <div>
                <label class="block text-white mb-1">نوع البضاعة</label>
                <input type="text" id="cargo_type" name="cargo_type" required class="form-input w-full rounded-lg" placeholder="مثال: إلكترونيات، ملابس...">
            </div>
            <div>
                <label class="block text-white mb-1">ملاحظات إضافية</label>
                <textarea id="description" name="description" class="form-input w-full rounded-lg" rows="2" placeholder="أي تفاصيل إضافية..."></textarea>
            </div>
            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold text-lg flex items-center justify-center gap-2">
                <i class="fas fa-paper-plane"></i> حفظ الشحنة
            </button>
        </form>
        <div id="statusMsg" class="mt-4 text-center text-white font-bold"></div>
        <div class="mt-6 text-center">
            <a href="index.html" class="text-blue-200 hover:text-white text-sm">
                <i class="fas fa-arrow-right ml-1"></i> العودة للوحة التحكم
            </a>
        </div>
    </div>
    <script>
    // GeoNames API Configuration
    const GEONAMES_USERNAME = 'gide1979';
    const GEONAMES_BASE_URL = 'http://api.geonames.org';

    // Cache for countries and cities
    let countriesCache = [];
    let citiesCache = {};

    // Load countries on page load
    document.addEventListener('DOMContentLoaded', async function() {
        await window.sessionManager.init();
        
        // Check user authentication and type
        if (!window.sessionManager.requireUserType('shipper')) {
            return; // Will redirect automatically
        }
        
        const user = window.sessionManager.getCurrentUser();
        if (!user) {
            alert('يرجى تسجيل الدخول أولاً');
            window.location.href = '../login.html';
            return;
        }

        // Load countries for autocomplete
        await loadCountries();

        const form = document.getElementById('addShipmentForm');
        const statusMsg = document.getElementById('statusMsg');
        
        form.onsubmit = async function(e) {
            e.preventDefault();
            statusMsg.textContent = 'جاري الحفظ...';
            statusMsg.className = 'mt-4 text-center text-yellow-200 font-bold';
            
            // Get form data
            const pickupDate = new Date(form.pickup_date.value);
            if (pickupDate < new Date()) {
                statusMsg.textContent = '❌ يرجى اختيار تاريخ مستقبلي للاستلام';
                statusMsg.className = 'mt-4 text-center text-red-200 font-bold';
                return;
            }
            
            // Get the current user
            const user = window.sessionManager.getCurrentUser();
            if (!user) {
                statusMsg.textContent = '❌ يرجى تسجيل الدخول أولاً';
                statusMsg.className = 'mt-4 text-center text-red-200 font-bold';
                return;
            }
            
            try {
                // Ensure shipper record exists and get shipper ID
                const shipperId = await window.sessionManager.ensureShipperRecord();
                
                const shipment = {
                    shipper_id: shipperId, // Use the shipper ID from ensureShipperRecord()
                    title: form.cargo_type.value.trim(), // Use cargo_type as title
                    description: form.description.value.trim() || null,
                    weight: parseFloat(form.weight_kg.value),
                    pickup_location: `${form.pickup_country.value.trim()}, ${form.pickup_city.value.trim()}, ${form.pickup_address.value.trim()}`,
                    delivery_location: `${form.delivery_country.value.trim()}, ${form.delivery_city.value.trim()}, ${form.delivery_address.value.trim()}`,
                    preferred_date: form.pickup_date.value,
                    status: 'pending',
                    created_at: new Date().toISOString()
                };
                
                try {
                    console.log('Submitting shipment:', shipment);
                    const { data, error } = await window.supabaseClient
                        .from('shipments')
                        .insert([shipment]);
                        
                    if (error) {
                        console.error('Database error:', error);
                        throw error;
                    }
                    
                    console.log('Shipment saved successfully:', data);
                    statusMsg.textContent = '✅ تم حفظ الشحنة بنجاح!';
                    statusMsg.className = 'mt-4 text-center text-green-200 font-bold';
                    
                    // Create notification for the shipper
                    try {
                        await window.sessionManager.createShipmentNotification(
                            'تم إضافة شحنة جديدة',
                            `تم إضافة شحنة من ${form.pickup_city.value.trim()} إلى ${form.delivery_city.value.trim()} بنجاح`,
                            data[0]?.id || null
                        );
                    } catch (notificationError) {
                        console.error('Error creating notification:', notificationError);
                        // Don't fail the whole operation if notification fails
                    }
                    
                    form.reset();
                    
                    // Optional: redirect to shipments list after 2 seconds
                    setTimeout(() => {
                        window.location.href = 'shipments.html';
                    }, 2000);
                    
                } catch (err) {
                    console.error('Error saving shipment:', err);
                    statusMsg.textContent = '❌ حدث خطأ أثناء حفظ الشحنة: ' + (err.message || 'خطأ غير معروف');
                    statusMsg.className = 'mt-4 text-center text-red-200 font-bold';
                }
            } catch (err) {
                console.error('Error preparing shipment:', err);
                statusMsg.textContent = '❌ حدث خطأ أثناء تحضير الشحنة: ' + (err.message || 'خطأ غير معروف');
                statusMsg.className = 'mt-4 text-center text-red-200 font-bold';
            }
        };
    });

    // Load countries from GeoNames
    async function loadCountries() {
        try {
            const response = await fetch(`${GEONAMES_BASE_URL}/countryInfoJSON?username=${GEONAMES_USERNAME}`);
            const data = await response.json();
            
            if (data.geonames) {
                countriesCache = data.geonames.map(country => ({
                    name: country.countryName,
                    code: country.countryCode
                }));
                
                // Setup autocomplete for country fields
                setupCountryAutocomplete('pickup_country');
                setupCountryAutocomplete('delivery_country');
            }
        } catch (error) {
            console.error('Error loading countries:', error);
        }
    }

    // Load cities for a specific country
    async function loadCities(countryCode, inputId) {
        if (citiesCache[countryCode]) {
            return citiesCache[countryCode];
        }

        try {
            const response = await fetch(`${GEONAMES_BASE_URL}/searchJSON?country=${countryCode}&featureClass=P&maxRows=50&username=${GEONAMES_USERNAME}`);
            const data = await response.json();
            
            if (data.geonames) {
                citiesCache[countryCode] = data.geonames.map(city => city.name);
                return citiesCache[countryCode];
            }
        } catch (error) {
            console.error('Error loading cities:', error);
        }
        
        return [];
    }

    // Setup autocomplete for country fields
    function setupCountryAutocomplete(inputId) {
        const input = document.getElementById(inputId);
        const datalistId = `${inputId}_list`;
        
        // Create datalist if it doesn't exist
        let datalist = document.getElementById(datalistId);
        if (!datalist) {
            datalist = document.createElement('datalist');
            datalist.id = datalistId;
            input.parentNode.appendChild(datalist);
        }
        
        // Set list attribute
        input.setAttribute('list', datalistId);
        
        // Populate datalist
        datalist.innerHTML = '';
        countriesCache.forEach(country => {
            const option = document.createElement('option');
            option.value = country.name;
            datalist.appendChild(option);
        });
        
        // Add event listener for city loading when country changes
        input.addEventListener('change', async function() {
            const selectedCountry = countriesCache.find(c => c.name === this.value);
            if (selectedCountry) {
                const cityInputId = inputId === 'pickup_country' ? 'pickup_city' : 'delivery_city';
                await setupCityAutocomplete(cityInputId, selectedCountry.code);
            }
        });
    }

    // Setup autocomplete for city fields
    async function setupCityAutocomplete(inputId, countryCode) {
        const cities = await loadCities(countryCode, inputId);
        const input = document.getElementById(inputId);
        const datalistId = `${inputId}_list`;
        
        // Create datalist if it doesn't exist
        let datalist = document.getElementById(datalistId);
        if (!datalist) {
            datalist = document.createElement('datalist');
            datalist.id = datalistId;
            input.parentNode.appendChild(datalist);
        }
        
        // Set list attribute
        input.setAttribute('list', datalistId);
        
        // Populate datalist
        datalist.innerHTML = '';
        cities.forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            datalist.appendChild(option);
        });
    }
    </script>
</body>
</html>
