<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المطابقات - الناقل | FastShip</title>
    <link rel="stylesheet" href="../shared/css/tailwind.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../config/supabase.js"></script>
    <script src="assets/js/session-manager.js"></script>
    <script src="../shared/js/matcher.js"></script>
    <script src="../shared/js/organized-messaging.js"></script>
    <script src="../shared/js/enhanced-notifications-v2.js"></script>
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        
        .header-gradient {
            background: linear-gradient(135deg, #0FAF74 0%, #0b8b5a 100%);
            box-shadow: 0 4px 20px rgba(15, 175, 116, 0.3);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .match-score {
            position: relative;
            width: 80px;
            height: 80px;
        }
        
        .match-score-circle {
            transform: rotate(-90deg);
        }
        
    .score-excellent { color: #0FAF74; }
        .score-good { color: #3b82f6; }
        .score-fair { color: #f59e0b; }
        .score-poor { color: #ef4444; }
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-new {
            background: linear-gradient(135deg, #0FAF74 0%, #0b8b5a 100%);
            color: white;
        }
        
        .badge-viewed {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .badge-contacted {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .rating-stars {
            color: #fbbf24;
        }
        
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        
        .empty-state i {
            font-size: 80px;
            color: #cbd5e1;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header-gradient text-white py-6 sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <button onclick="window.location.href='dashboard.html'" class="text-white hover:bg-white/20 p-2 rounded-lg transition">
                        <i class="fas fa-arrow-right text-xl"></i>
                    </button>
                    <div>
                        <h1 class="text-2xl font-bold">المطابقات المتاحة</h1>
                        <p class="text-white/80 text-sm">شحنات متطابقة مع رحلاتك</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="refreshMatches()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition" id="refreshBtn">
                        <i class="fas fa-sync-alt"></i> تحديث
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        
        <!-- Filters -->
        <div class="glass-card p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">اختر الرحلة</label>
                    <select id="tripFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        <option value="">كل الرحلات</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">نقاط المطابقة</label>
                    <select id="scoreFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        <option value="0">الكل</option>
                        <option value="80">ممتاز (80%+)</option>
                        <option value="60">جيد (60%+)</option>
                        <option value="40">مقبول (40%+)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">الحالة</label>
                    <select id="statusFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        <option value="">الكل</option>
                        <option value="new">جديد</option>
                        <option value="viewed">تم المشاهدة</option>
                        <option value="contacted">تم التواصل</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="applyFilters()" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-2 rounded-lg hover:from-green-700 hover:to-emerald-700 transition">
                        <i class="fas fa-filter"></i> تطبيق
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="glass-card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">إجمالي المطابقات</p>
                        <p class="text-3xl font-bold text-green-600" id="totalMatches">0</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-full">
                        <i class="fas fa-bullseye text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="glass-card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">مطابقات ممتازة</p>
                        <p class="text-3xl font-bold text-emerald-600" id="excellentMatches">0</p>
                    </div>
                    <div class="bg-emerald-100 p-4 rounded-full">
                        <i class="fas fa-star text-emerald-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="glass-card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">جديدة</p>
                        <p class="text-3xl font-bold text-blue-600" id="newMatches">0</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-full">
                        <i class="fas fa-bell text-blue-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="glass-card p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">تم التواصل</p>
                        <p class="text-3xl font-bold text-orange-600" id="contactedMatches">0</p>
                    </div>
                    <div class="bg-orange-100 p-4 rounded-full">
                        <i class="fas fa-comments text-orange-600 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Matches List -->
        <div id="matchesContainer">
            <!-- سيتم ملؤها بالـ JavaScript -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden">
            <div class="glass-card empty-state">
                <i class="fas fa-search"></i>
                <h3 class="text-2xl font-bold text-gray-700 mb-2">لا توجد مطابقات حالياً</h3>
                <p class="text-gray-600 mb-6">لم نجد أي شحنات متطابقة مع رحلاتك في الوقت الحالي</p>
                <button onclick="window.location.href='add-trip.html'" class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-3 rounded-lg hover:from-green-700 hover:to-emerald-700 transition">
                    <i class="fas fa-plus-circle ml-2"></i>
                    أضف رحلة جديدة
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="space-y-4">
            <div class="glass-card p-6 skeleton h-48"></div>
            <div class="glass-card p-6 skeleton h-48"></div>
            <div class="glass-card p-6 skeleton h-48"></div>
        </div>
    </main>

    <!-- Contact Modal -->
    <div id="contactModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="glass-card max-w-lg w-full p-6 relative max-h-[90vh] overflow-y-auto">
            <button onclick="closeContactModal()" class="absolute top-4 left-4 text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
            
            <h2 class="text-xl font-bold mb-4 text-gray-800">طلب تواصل مع صاحب الشحنة</h2>
            
            <div id="modalTripInfo" class="bg-gray-50 p-3 rounded-lg mb-4 text-sm"></div>
            <div id="modalShipmentInfo" class="bg-green-50 p-3 rounded-lg mb-4 text-sm"></div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">رسالتك لصاحب الشحنة</label>
                <textarea id="contactMessage" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm" placeholder="اكتب رسالتك هنا..."></textarea>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">السعر المقترح (ريال/كجم)</label>
                <input type="number" id="offeredPrice" step="0.1" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-sm" placeholder="مثال: 5.5">
            </div>
            
            <div class="flex gap-3">
                <button onclick="sendContactRequest()" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white px-4 py-2 rounded-lg hover:from-green-700 hover:to-emerald-700 transition text-sm">
                    <i class="fas fa-paper-plane ml-2"></i>
                    إرسال الطلب
                </button>
                <button onclick="closeContactModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition text-sm">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <script>
        let allMatches = [];
        let currentMatch = null;
        let userTrips = [];

        // تحميل البيانات عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', async () => {
            // تهيئة المطابق إذا لم يكن موجوداً
            if (!window.fastShipMatcher) {
                window.fastShipMatcher = new FastShipMatcherV2();
            }
            
            // تهيئة session manager أولاً
            if (window.sessionManager) {
                await window.sessionManager.init();
                
                if (!window.sessionManager.isLoggedIn()) {
                    window.location.href = 'login.html';
                    return;
                }
                
                const userType = window.sessionManager.getUserType();
                if (userType !== 'carrier') {
                    alert('هذه الصفحة مخصصة للناقلين فقط');
                    window.sessionManager.goToDashboard();
                    return;
                }
                
                // تهيئة الأنظمة المحسنة
                const user = window.sessionManager.getCurrentUser();
                if (window.enhancedNotifications) {
                    await window.enhancedNotifications.init(user);
                }
                if (window.enhancedMessaging) {
                    await window.enhancedMessaging.init(user);
                }
                
                await loadUserTrips();
                await loadMatches();
            }
        });

        // تحميل رحلات المستخدم
        async function loadUserTrips() {
            try {
                const user = window.sessionManager.getCurrentUser();
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }

                // الحصول على معرف الناقل أو إنشاؤه إذا لم يكن موجوداً
                const carrierId = await window.sessionManager.ensureCarrierRecord();
                if (!carrierId) {
                    console.warn('تعذر إنشاء أو العثور على حساب الناقل');
                    userTrips = [];
                    return;
                }

                const { data: trips, error } = await window.supabaseClient
                    .from('trips')
                    .select('*')
                    .eq('carrier_id', carrierId)
                    .in('status', ['pending', 'active'])
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('خطأ في تحميل الرحلات:', error);
                    userTrips = [];
                    return;
                }

                userTrips = trips || [];
                
                // ملء قائمة الرحلات في الفلتر
                const tripFilter = document.getElementById('tripFilter');
                tripFilter.innerHTML = '<option value="">كل الرحلات</option>';
                trips.forEach(trip => {
                    const option = document.createElement('option');
                    option.value = trip.id;
                    option.textContent = `${trip.title} - ${trip.origin} → ${trip.destination}`;
                    tripFilter.appendChild(option);
                });

            } catch (error) {
                console.error('خطأ في تحميل الرحلات:', error);
                userTrips = [];
            }
        }

        // تحميل المطابقات
        async function loadMatches() {
            try {
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('matchesContainer').innerHTML = '';
                document.getElementById('emptyState').classList.add('hidden');

                const user = window.sessionManager.getCurrentUser();
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }

                // الحصول على معرف الناقل
                const carrierId = await window.sessionManager.ensureCarrierRecord();
                if (!carrierId) {
                    console.error('تعذر تحديد حساب الناقل');
                    document.getElementById('loadingState').classList.add('hidden');
                    document.getElementById('emptyState').classList.remove('hidden');
                    return;
                }

                // البحث عن رحلات الناقل النشطة
                const { data: carrierTrips, error: tripsError } = await window.supabaseClient
                    .from('trips')
                    .select('*')
                    .eq('carrier_id', carrierId)
                    .in('status', ['pending', 'active']);

                if (tripsError) {
                    console.error('خطأ في تحميل الرحلات:', tripsError);
                    document.getElementById('loadingState').classList.add('hidden');
                    document.getElementById('emptyState').classList.remove('hidden');
                    return;
                }

                if (!carrierTrips || carrierTrips.length === 0) {
                    console.log('لا توجد رحلات نشطة');
                    document.getElementById('loadingState').classList.add('hidden');
                    document.getElementById('emptyState').classList.remove('hidden');
                    return;
                }

                console.log('تم العثور على', carrierTrips.length, 'رحلة نشطة');

                let allMatchedShipments = [];
                
                // البحث عن الشحنات المتطابقة لكل رحلة
                for (const trip of carrierTrips) {
                    console.log('البحث عن شحنات مطابقة للرحلة:', trip.origin, '→', trip.destination);
                    
                    // البحث عن جميع الشحنات المتاحة وتصفيتها محلياً لضمان الدقة
                    const { data: allShipments, error: shipmentsError } = await window.supabaseClient
                        .from('shipments')
                        .select(`
                            *,
                            shippers (
                                id,
                                user_id,
                                rating,
                                total_shipments,
                                users (
                                    id,
                                    full_name,
                                    phone,
                                    email
                                )
                            )
                        `)
                        .eq('status', 'pending');

                    if (shipmentsError) {
                        console.error('خطأ في البحث عن الشحنات:', shipmentsError);
                        continue;
                    }

                    console.log('تم العثور على', allShipments?.length || 0, 'شحنة متاحة إجمالاً');

                    // تصفية الشحنات محلياً بناءً على التطابق مع الرحلة
                    const originCity = extractCity(trip.origin).toLowerCase();
                    const destinationCity = extractCity(trip.destination).toLowerCase();
                    const originCountry = extractCountry(trip.origin).toLowerCase();
                    const destinationCountry = extractCountry(trip.destination).toLowerCase();
                    
                    const shipments = allShipments?.filter(shipment => {
                        const pickupCity = extractCity(shipment.pickup_location).toLowerCase();
                        const deliveryCity = extractCity(shipment.delivery_location).toLowerCase();
                        const pickupCountry = extractCountry(shipment.pickup_location).toLowerCase();
                        const deliveryCountry = extractCountry(shipment.delivery_location).toLowerCase();
                        
                        // منطق التطابق المحسن:
                        // 1. تطابق كامل في الدول والمدن
                        const fullMatch = (
                            (pickupCountry === originCountry && deliveryCountry === destinationCountry) &&
                            (pickupCity.includes(originCity) || originCity.includes(pickupCity)) &&
                            (deliveryCity.includes(destinationCity) || destinationCity.includes(deliveryCity))
                        );
                        
                        // 2. تطابق في نفس الدولة مع مدن مختلفة (رحلات داخلية)
                        const sameCountryMatch = (
                            pickupCountry === originCountry && deliveryCountry === destinationCountry &&
                            pickupCountry === deliveryCountry // نفس الدولة
                        );
                        
                        // 3. تطابق جزئي قوي: نفس نقطة البداية على الأقل
                        const strongPartialMatch = (
                            (pickupCity.includes(originCity) || originCity.includes(pickupCity)) &&
                            (deliveryCity.includes(destinationCity) || destinationCity.includes(deliveryCity))
                        );
                        
                        return fullMatch || sameCountryMatch || strongPartialMatch;
                    }) || [];

                    console.log('بعد التصفية المحلية:', shipments.length, 'شحنة مطابقة للرحلة');
                    console.log('معلومات الرحلة:', { originCity, destinationCity, originCountry, destinationCountry });
                    if (shipments.length > 0) {
                        console.log('عينات من الشحنات المطابقة:', shipments.slice(0, 2).map(s => ({
                            id: s.id,
                            pickup: s.pickup_location,
                            delivery: s.delivery_location,
                            pickupCountry: extractCountry(s.pickup_location),
                            deliveryCountry: extractCountry(s.delivery_location)
                        })));
                    }

                    if (shipmentsError) {
                        console.error('خطأ في البحث عن الشحنات:', shipmentsError);
                        continue;
                    }

                    console.log('تم العثور على', shipments?.length || 0, 'شحنة محتملة للرحلة');

                    // حساب درجة المطابقة لكل شحنة
                    if (shipments && shipments.length > 0) {
                        for (const shipment of shipments) {
                            const matchScore = calculateMatchScore(trip, shipment);
                            
                            // إضافة الشحنة إذا كانت درجة المطابقة جيدة
                            if (matchScore >= 30) {
                                allMatchedShipments.push({
                                    trip: trip,
                                    shipment: shipment,
                                    matchScore: matchScore,
                                    matchReasons: getMatchReasons(shipment, trip)
                                });
                            }
                        }
                    }
                }

                // ترتيب النتائج حسب درجة المطابقة
                allMatchedShipments.sort((a, b) => b.matchScore - a.matchScore);
                
                console.log('إجمالي الشحنات المتطابقة:', allMatchedShipments.length);

                // تحديث المتغير العام
                allMatches = allMatchedShipments;

                document.getElementById('loadingState').classList.add('hidden');
                
                if (allMatchedShipments.length === 0) {
                    document.getElementById('emptyState').classList.remove('hidden');
                } else {
                    displayMatches(allMatchedShipments);
                    updateStats(allMatchedShipments);
                }

            } catch (error) {
                console.error('خطأ في تحميل المطابقات:', error);
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
            }
        }

        // عرض المطابقات
        function displayMatches(matches) {
            const container = document.getElementById('matchesContainer');
            container.innerHTML = '';

            matches.forEach(match => {
                const card = createMatchCard(match);
                container.appendChild(card);
            });
        }

        // إنشاء بطاقة مطابقة
        function createMatchCard(match) {
            const div = document.createElement('div');
            div.className = 'glass-card p-6 mb-4';
            
            const score = match.matchScore;
            const scoreClass = score >= 80 ? 'score-excellent' : score >= 60 ? 'score-good' : score >= 40 ? 'score-fair' : 'score-poor';
            
            const rating = match.shipment?.shippers?.rating || 5.0;
            const starsHtml = Array.from({length: 5}, (_, i) => 
                `<i class="fas fa-star ${i < Math.floor(rating) ? 'text-yellow-400' : 'text-gray-300'}"></i>`
            ).join('');

            div.innerHTML = `
                <div class="flex flex-col lg:flex-row gap-6">
                    <!-- Match Score -->
                    <div class="flex flex-col items-center justify-center">
                        <div class="match-score relative">
                            <svg class="w-full h-full" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" fill="none" stroke="#e5e7eb" stroke-width="8"/>
                                <circle class="match-score-circle ${scoreClass}" cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="8" 
                                    stroke-dasharray="${2 * Math.PI * 45}" 
                                    stroke-dashoffset="${2 * Math.PI * 45 * (1 - score / 100)}"
                                    stroke-linecap="round"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center flex-col">
                                <span class="text-2xl font-bold ${scoreClass}">${score}%</span>
                                <span class="text-xs text-gray-500">توافق</span>
                            </div>
                        </div>
                        <span class="badge badge-new mt-3">جديد</span>
                    </div>

                    <!-- Trip Info -->
                    <div class="flex-1 border-r-2 border-gray-200 pr-6">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">${match.trip?.title}</h3>
                                <p class="text-sm text-gray-600">رحلتك</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-route text-green-600"></i>
                                <span class="font-medium">من:</span>
                                <span class="text-gray-600">${match.trip?.origin}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-flag-checkered text-red-600"></i>
                                <span class="font-medium">إلى:</span>
                                <span class="text-gray-600">${match.trip?.destination}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-box text-orange-600"></i>
                                <span class="font-medium">السعة المتاحة:</span>
                                <span class="text-gray-600">${match.trip?.capacity} كجم</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-calendar-day text-purple-600"></i>
                                <span class="font-medium">تاريخ الرحلة:</span>
                                <span class="text-gray-600">${new Date(match.trip?.travel_date).toLocaleDateString('ar-SA')}</span>
                            </div>
                            ${match.trip?.price_per_kg ? `
                            <div class="flex items-center gap-2">
                                <i class="fas fa-money-bill-wave text-green-600"></i>
                                <span class="font-medium">السعر:</span>
                                <span class="text-gray-600">${match.trip.price_per_kg} ريال/كجم</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Shipment Info -->
                    <div class="flex-1">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800">${match.shipment?.shippers?.users?.full_name || 'شاحن غير محدد'}</h3>
                                <div class="flex items-center gap-2 mt-1">
                                    ${starsHtml}
                                    <span class="text-sm text-gray-600">(${match.shipment?.shippers?.total_shipments || 0} شحنة)</span>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm mb-4">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-box text-blue-600"></i>
                                <span class="font-medium">الشحنة:</span>
                                <span class="text-gray-600">${match.shipment?.title}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-map-marker-alt text-green-600"></i>
                                <span class="font-medium">من:</span>
                                <span class="text-gray-600">${match.shipment?.pickup_location}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-map-marker-alt text-red-600"></i>
                                <span class="font-medium">إلى:</span>
                                <span class="text-gray-600">${match.shipment?.delivery_location}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-weight-hanging text-blue-600"></i>
                                <span class="font-medium">الوزن:</span>
                                <span class="text-gray-600">${match.shipment?.weight} كجم</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fas fa-calendar text-purple-600"></i>
                                <span class="font-medium">التاريخ المفضل:</span>
                                <span class="text-gray-600">${new Date(match.shipment?.preferred_date).toLocaleDateString('ar-SA')}</span>
                            </div>
                            ${match.shipment?.price ? `
                            <div class="flex items-center gap-2">
                                <i class="fas fa-money-bill-wave text-green-600"></i>
                                <span class="font-medium">الميزانية:</span>
                                <span class="text-gray-600">${match.shipment.price} ريال</span>
                            </div>
                            ` : ''}
                        </div>

                        <!-- Match Reasons -->
                        ${match.matchReasons && match.matchReasons.length > 0 ? `
                        <div class="bg-green-50 p-3 rounded-lg mb-4">
                            <p class="text-sm font-medium text-green-800 mb-2">أسباب المطابقة:</p>
                            <div class="flex flex-wrap gap-2">
                                ${match.matchReasons.map(reason => `
                                    <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs">
                                        <i class="fas fa-check-circle mr-1"></i>${reason}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}

                        <!-- Actions -->
                        <div class="flex gap-3">
                            <button onclick="openContactModal('${match.trip.id}', '${match.shipment.id}')" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white px-4 py-2 rounded-lg hover:from-green-700 hover:to-emerald-700 transition">
                                <i class="fas fa-comments ml-2"></i>
                                عرض عليه النقل
                            </button>
                            ${match.shipment?.shippers?.users?.phone ? `
                            <a href="https://wa.me/${match.shipment.shippers.users.phone.replace(/[^0-9]/g, '')}" target="_blank"
                               class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition flex items-center justify-center">
                                <i class="fab fa-whatsapp text-xl"></i>
                            </a>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            return div;
        }

        // تحديث الإحصائيات
        function updateStats(matches) {
            document.getElementById('totalMatches').textContent = matches.length;
            document.getElementById('excellentMatches').textContent = matches.filter(m => m.matchScore >= 80).length;
            document.getElementById('newMatches').textContent = matches.length; // كلها جديدة في البحث المباشر
            document.getElementById('contactedMatches').textContent = '0'; // لا توجد بيانات سابقة
        }

        // تطبيق الفلاتر
        function applyFilters() {
            const tripId = document.getElementById('tripFilter').value;
            const minScore = parseInt(document.getElementById('scoreFilter').value);
            const status = document.getElementById('statusFilter').value;

            let filtered = [...allMatches];

            if (tripId) {
                filtered = filtered.filter(m => m.trip.id === tripId);
            }

            if (minScore > 0) {
                filtered = filtered.filter(m => m.matchScore >= minScore);
            }

            // في البحث المباشر، كل المطابقات جديدة
            if (status && status !== '') {
                // لا نحتاج لفلترة الحالة في البحث المباشر
            }

            displayMatches(filtered);
            updateStats(filtered);
        }

        // تحديث المطابقات
        async function refreshMatches() {
            const btn = document.getElementById('refreshBtn');
            btn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> جاري التحديث...';
            btn.disabled = true;

            await loadMatches();

            btn.innerHTML = '<i class="fas fa-sync-alt"></i> تحديث';
            btn.disabled = false;
        }

        // فتح نافذة طلب التواصل
        async function openContactModal(tripId, shipmentId) {
            // العثور على المطابقة المحددة
            const match = allMatches.find(m => m.trip.id === tripId && m.shipment.id === shipmentId);
            if (!match) return;

            currentMatch = match;

            document.getElementById('modalTripInfo').innerHTML = `
                <h4 class="font-bold mb-2">رحلتك:</h4>
                <p class="text-sm">${match.trip.title}</p>
                <p class="text-sm text-gray-600">${match.trip.origin} → ${match.trip.destination}</p>
            `;

            document.getElementById('modalShipmentInfo').innerHTML = `
                <h4 class="font-bold mb-2">الشحنة المطلوبة:</h4>
                <p class="text-sm">${match.shipment.title}</p>
                <p class="text-sm text-gray-600">${match.shipment.pickup_location} → ${match.shipment.delivery_location}</p>
                <p class="text-sm text-gray-600">الوزن: ${match.shipment.weight} كجم</p>
            `;

            document.getElementById('contactMessage').value = `مرحباً، أنا ناقل لدي رحلة متطابقة مع شحنتك. يمكنني نقلها بأمان وفي الوقت المناسب.`;

            // اقتراح سعر تلقائي
            const suggestedPrice = match.trip?.price_per_kg || 5.0;
            document.getElementById('offeredPrice').value = suggestedPrice;

            document.getElementById('contactModal').classList.remove('hidden');
        }

        // إغلاق نافذة طلب التواصل
        function closeContactModal() {
            document.getElementById('contactModal').classList.add('hidden');
            currentMatch = null;
        }

        // إرسال طلب التواصل
        async function sendContactRequest() {
            if (!currentMatch) return;

            const messageBody = document.getElementById('contactMessage').value;
            const offeredPrice = parseFloat(document.getElementById('offeredPrice').value);
            
            if (!messageBody.trim()) {
                alert('الرجاء كتابة رسالة');
                return;
            }

            try {
                const user = window.sessionManager.getCurrentUser();
                if (!user?.profile?.id) {
                    throw new Error('تعذر تحديد معرف المستخدم الداخلي');
                }

                const carrierId = await window.sessionManager.ensureCarrierRecord();
                if (!carrierId) {
                    throw new Error('تعذر تحديد حساب الناقل');
                }

                // التحقق من صحة بيانات الشحنة
                if (!currentMatch.shipment?.shippers) {
                    console.error('بيانات الشاحن غير متوفرة');
                    throw new Error('تعذر تحديد مستلم الرسالة - بيانات الشاحن غير متوفرة');
                }

                // الحصول على بيانات الشاحن (قد يكون كائن أو مصفوفة)
                let shipper;
                if (Array.isArray(currentMatch.shipment.shippers)) {
                    if (currentMatch.shipment.shippers.length === 0) {
                        console.error('مصفوفة الشاحنين فارغة');
                        throw new Error('تعذر تحديد مستلم الرسالة - بيانات الشاحن غير متوفرة');
                    }
                    shipper = currentMatch.shipment.shippers[0];
                } else {
                    shipper = currentMatch.shipment.shippers;
                }

                if (!shipper?.users?.id) {
                    console.error('بيانات المستخدم للشاحن غير مكتملة:', shipper);
                    throw new Error('تعذر تحديد مستلم الرسالة - بيانات الشاحن غير مكتملة');
                }

                const recipientId = shipper.users.id;

                // إنشاء رسالة في جدول الرسائل
                let messageContent = messageBody;
                if (offeredPrice && !isNaN(offeredPrice)) {
                    messageContent += `\n\nالسعر المقترح: ${offeredPrice} ريال`;
                }
                
                const messagePayload = {
                    sender_id: user.profile.id,
                    receiver_id: recipientId,
                    subject: `عرض نقل لشحنة: ${currentMatch.shipment.title}`,
                    content: messageContent,
                    message_type: 'match_offer',
                    folder: 'inbox',
                    is_read: false,
                    created_at: new Date().toISOString()
                };

                console.log('إرسال رسالة:', messagePayload);

                const { data: messageData, error: messageError } = await window.supabaseClient
                    .from('messages')
                    .insert([messagePayload])
                    .select();

                if (messageError) {
                    console.error('خطأ في إرسال الرسالة:', messageError);
                    // لا نتوقف هنا، نستمر في محاولة إرسال contact_request
                } else {
                    console.log('تم إرسال الرسالة بنجاح:', messageData);
                }

                // محاولة إنشاء contact_request بالطريقة المباشرة
                try {
                    const contactPayload = {
                        carrier_id: carrierId,
                        shipper_id: shipper.id,
                        trip_id: currentMatch.trip.id,
                        shipment_id: currentMatch.shipment.id,
                        match_id: currentMatch.id,
                        message: messageBody,
                        offered_price: offeredPrice && !isNaN(offeredPrice) ? offeredPrice : null,
                        status: 'pending',
                        created_at: new Date().toISOString()
                    };

                    console.log('إرسال طلب تواصل:', contactPayload);

                    const { data: contactData, error: contactError } = await window.supabaseClient
                        .from('contact_requests')
                        .insert([contactPayload]);

                    if (contactError) {
                        console.warn('تعذر إنشاء contact_request (ربما الجدول غير موجود أو مشكلة في الصلاحيات):', contactError);
                        // لا نتوقف هنا، الرسالة تم إرسالها بالفعل
                    } else {
                        console.log('تم إنشاء contact_request بنجاح:', contactData);
                    }
                } catch (contactError) {
                    console.warn('خطأ في إنشاء contact_request:', contactError);
                    // لا نتوقف هنا، الرسالة تم إرسالها بالفعل
                }

                // محاولة إرسال إشعار للشاحن بالطريقة المباشرة
                try {
                    const notificationPayload = {
                        user_id: recipientId,
                        type: 'message',
                        title: 'عرض نقل جديد!',
                        message: `${user.profile?.full_name || user.email} يريد نقل شحنتك "${currentMatch.shipment.title}"`,
                        priority: 'high',
                        icon: 'fas fa-truck',
                        action_url: '/shipper-app/messages.html',
                        action_text: 'عرض التفاصيل',
                        is_read: false,
                        created_at: new Date().toISOString()
                    };

                    const { error: notificationError } = await window.supabaseClient
                        .from('notifications')
                        .insert([notificationPayload]);

                    if (notificationError) {
                        console.warn('تعذر إرسال الإشعار (ربما مشكلة في الصلاحيات):', notificationError);
                        // لا نتوقف هنا
                    } else {
                        console.log('تم إرسال الإشعار بنجاح');
                    }
                } catch (notificationError) {
                    console.warn('خطأ في إرسال الإشعار:', notificationError);
                    // لا نتوقف هنا
                }

                alert('✅ تم إرسال عرض النقل بنجاح!');
                closeContactModal();

            } catch (error) {
                console.error('خطأ في إرسال الطلب:', error);
                alert('حدث خطأ في إرسال الطلب: ' + error.message);
            }
        }

        // تحديد المطابقة كمشاهدة (غير مطلوب في البحث المباشر)
        async function markAsViewed(matchId) {
            // في البحث المباشر، لا نحتاج لتحديث حالة المشاهدة
            console.log('تم عرض المطابقة:', matchId);
        }

        // دالة مساعدة لاستخراج اسم المدينة
        function extractCity(location) {
            if (!location) return '';
            const parts = location.split(',');
            return parts.length > 1 ? parts[1].trim() : parts[0].trim();
        }

        // دالة مساعدة لاستخراج اسم الدولة
        function extractCountry(location) {
            if (!location) return '';
            const parts = location.split(',');
            return parts[0].trim();
        }

        // دالة حساب درجة المطابقة
        function calculateMatchScore(trip, shipment) {
            let score = 0;
            
            // تطابق المدن (50 نقطة)
            const tripOrigin = extractCity(trip.origin).toLowerCase();
            const tripDestination = extractCity(trip.destination).toLowerCase();
            const shipmentOrigin = extractCity(shipment.pickup_location).toLowerCase();
            const shipmentDestination = extractCity(shipment.delivery_location).toLowerCase();
            
            if (tripOrigin.includes(shipmentOrigin) || shipmentOrigin.includes(tripOrigin)) {
                score += 25;
            }
            if (tripDestination.includes(shipmentDestination) || shipmentDestination.includes(tripDestination)) {
                score += 25;
            }
            
            // تطابق نوع الناقل (30 نقطة)
            if (trip.vehicle_type && shipment.vehicle_type_preferred) {
                if (trip.vehicle_type === shipment.vehicle_type_preferred || 
                    trip.vehicle_type === 'any' || 
                    shipment.vehicle_type_preferred === 'any') {
                    score += 30;
                }
            }
            
            // تطابق التاريخ (20 نقطة)
            if (trip.travel_date && shipment.preferred_date) {
                const tripDate = new Date(trip.travel_date);
                const shipmentDate = new Date(shipment.preferred_date);
                const daysDiff = Math.abs((tripDate - shipmentDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff <= 1) score += 20;
                else if (daysDiff <= 3) score += 15;
                else if (daysDiff <= 7) score += 10;
            }
            
            return score;
        }

        // دالة الحصول على أسباب المطابقة
        function getMatchReasons(shipment, trip) {
            const reasons = [];

            const pickupMatch = extractCity(shipment.pickup_location).toLowerCase().includes(extractCity(trip.origin).toLowerCase()) ||
                               extractCity(trip.origin).toLowerCase().includes(extractCity(shipment.pickup_location).toLowerCase());
            const deliveryMatch = extractCity(shipment.delivery_location).toLowerCase().includes(extractCity(trip.destination).toLowerCase()) ||
                                 extractCity(trip.destination).toLowerCase().includes(extractCity(shipment.delivery_location).toLowerCase());

            if (pickupMatch) reasons.push('موقع الاستلام متطابق');
            if (deliveryMatch) reasons.push('موقع التسليم متطابق');

            const shipmentWeight = parseFloat(shipment.weight);
            const capacity = parseFloat(trip.capacity);
            if (shipmentWeight <= capacity) reasons.push('السعة كافية');

            if (trip.travel_date && shipment.preferred_date) {
                const tripDate = new Date(trip.travel_date);
                const shipmentDate = new Date(shipment.preferred_date);
                const daysDiff = Math.abs((tripDate - shipmentDate) / (1000 * 60 * 60 * 24));
                if (daysDiff <= 1) reasons.push('التاريخ متطابق');
            }

            if (shipment.shippers?.rating >= 4.5) reasons.push('شاحن موثوق');

            return reasons;
        }
    </script>
</body>
</html>